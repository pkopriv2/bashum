#! /usr/bin/env bash

export bashum_cmd=${bashum_cmd:-bashum}
export bashum_home=${bashum_home:-$HOME/.bashum}
export bashums_home=${bashums_home:-$bashum_home/bashums}
export bashum_tmp_dir=${bashum_tmp_dir:-/tmp/bashum/}

source $bashum_home/lib/require.sh

require 'lib/error.sh'
require 'lib/info.sh'
require 'lib/font.sh'

# ensure all the required directories are there.
if [[ ! -d $bashums_home ]]
then
	mkdir -p $bashums_home 
fi

if [[ -d $bashum_tmp_dir ]] 
then
	rm -r $bashum_tmp_dir
fi

mkdir -p $bashum_tmp_dir

# set basic traps 
on_exit() {
	rm -r $bashum_tmp_dir
}; trap "on_exit" EXIT

bashum_help() {
	bold "BASHUM HELP"
	echo 

	printf "%s\n" '
	Bashum is a package manager for bash projects.  It provides support
	for building, installing, and maintaining .bashum files.  
'

	bold "COMMANDS"
	echo

	for command in $bashum_home/commands/*.sh
	do
		source $command

		cmd=$(basename $command)
		cmd=${cmd/.sh/}

		printf "\t"; "$cmd"_usage "$@" 
	done
	echo 

	bold 'MORE INFO'
	printf "%s\n" '
	To get more detailed help, simply type bashum <command> help [--detailed]

'
}

args=( "${@}" )
action="${args[0]}"

if [[ -z $action ]] 
then
	bashum_help
	exit $?
fi
shift

if [[ ! -f $bashum_home/commands/"$action".sh ]]
then
	case "$action" in
		help|-h|--help)
			bashum_help 
			;;
		*)
			error "That sub-command is not supported."
			echo
			bashum_help
			;;
	esac

	exit $?
fi

require "commands/$action.sh"
$action "$@"
exit $?
